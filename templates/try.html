from flask import Flask, render_template, request, send_file, jsonify, flash, redirect, url_for
from data import collect_resume_data  # Modify this import based on your data structure
from modules.resume_generator_module import ResumeGenerator
import os
import io

app = Flask(_name_)
app.secret_key = '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'  # Required for flash messages

@app.route('/')
def home():
    return render_template('home.html')

@app.route('/build-resume')
def build_resume():
    return render_template('build_resume.html')

@app.route('/generate-resume', methods=['POST'])
def generate_resume():
    try:
        # Collecting form data
        resume_data = {
            "personal_info": {
                "name": request.form.get('name'),
                "email": request.form.get('email'),
                "phone": request.form.get('phone'),
                "linkedin": request.form.get('linkedin'),
                "location": request.form.get('location')
            },
            "professional_summary": request.form.get('professional_summary'),
            "work_experience": [],
            "education": [],
            "skills": request.form.getlist('skills')
        }

        # Handle work experience (assuming it's sent as multiple entries)
        work_experiences = zip(
            request.form.getlist('company_name'),
            request.form.getlist('position'),
            request.form.getlist('work_dates'),
            request.form.getlist('work_description')
        )
        
        for company, position, dates, description in work_experiences:
            if company and position:  # Only add if essential fields are present
                resume_data["work_experience"].append({
                    "company": company,
                    "position": position,
                    "dates": dates,
                    "description": description
                })

        # Handle education entries
        educations = zip(
            request.form.getlist('institution'),
            request.form.getlist('degree'),
            request.form.getlist('education_dates'),
            request.form.getlist('gpa')
        )
        
        for institution, degree, dates, gpa in educations:
            if institution and degree:  # Only add if essential fields are present
                resume_data["education"].append({
                    "institution": institution,
                    "degree": degree,
                    "dates": dates,
                    "gpa": gpa
                })

        # Validate required fields
        if not resume_data["personal_info"]["name"]:
            flash("Please enter at least your name to generate a resume.", "error")
            return redirect(url_for('build_resume'))

        # Generate PDF
        generator = ResumeGenerator()
        pdf = generator.create_professional_pdf(resume_data)

        # Create a BytesIO object to serve the PDF
        pdf_buffer = io.BytesIO(pdf)
        pdf_buffer.seek(0)

        return send_file(
            pdf_buffer,
            download_name=f"{resume_data['personal_info']['name'].replace(' ', '_')}_professional_resume.pdf",
            mimetype='application/pdf',
            as_attachment=True
        )

    except Exception as e:
        flash(f"Error generating PDF: {str(e)}", "error")
        return redirect(url_for('build_resume'))

@app.route('/upload-resume', methods=['POST'])
def upload_resume():
    if 'resume' not in request.files:
        return jsonify({'error': 'No file uploaded'}), 400
    
    file = request.files['resume']
    if file.filename == '':
        return jsonify({'error': 'No file selected'}), 400
    
    if file and allowed_file(file.filename):
        # Process the uploaded resume
        # Add your resume processing logic here
        return jsonify({'message': 'Resume uploaded successfully'})
    
    return jsonify({'error': 'Invalid file type'}), 400

def allowed_file(filename):
    ALLOWED_EXTENSIONS = {'pdf', 'doc', 'docx'}
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

if _name_ == '_main_':
    app.run(debug=True)